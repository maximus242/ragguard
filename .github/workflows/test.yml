name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run unit tests
      run: |
        pytest tests/ \
          --ignore=tests/integration/ \
          --ignore=tests/enterprise/ \
          -v \
          --cov=ragguard \
          --cov-report=xml \
          --cov-report=term-missing

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.python-version }}
        token: ${{ secrets.CODECOV_TOKEN }}

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests  # Only run if unit tests pass

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,qdrant,chromadb,weaviate,pgvector]"

    - name: Start databases with docker-compose
      run: |
        docker compose up -d
        echo "Waiting for databases to be ready..."
        sleep 30

    - name: Check database health
      run: |
        # Check Qdrant
        curl -f http://localhost:6333/healthz || echo "Qdrant not ready"

        # Check ChromaDB
        curl -f http://localhost:8000/api/v1/heartbeat || echo "ChromaDB not ready"

        # Check Weaviate
        curl -f http://localhost:8080/v1/.well-known/ready || echo "Weaviate not ready"

        # Check PostgreSQL
        docker exec $(docker ps -qf "name=postgres") pg_isready -U ragguard || echo "PostgreSQL not ready"

        # Give databases more time if needed
        sleep 10

    - name: Run integration tests
      run: |
        pytest tests/integration/ \
          -v \
          --cov=ragguard \
          --cov-report=xml \
          --cov-report=term-missing

    - name: Show database logs on failure
      if: failure()
      run: |
        echo "=== Qdrant logs ==="
        docker logs $(docker ps -qf "name=qdrant") || true
        echo "=== ChromaDB logs ==="
        docker logs $(docker ps -qf "name=chromadb") || true
        echo "=== Weaviate logs ==="
        docker logs $(docker ps -qf "name=weaviate") || true
        echo "=== PostgreSQL logs ==="
        docker logs $(docker ps -qf "name=postgres") || true

    - name: Stop databases
      if: always()
      run: |
        docker compose down -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: integration
        name: codecov-integration
        token: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install ruff mypy types-PyYAML

    - name: Run ruff (linter)
      run: |
        ruff check ragguard/ tests/ --select=E,F,W,I --ignore=E501,F401,E402,E712,E722,E741,F841

    - name: Run mypy (type checker)
      run: |
        mypy ragguard/
      # Configuration in mypy.ini - enforces types on core modules

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit pip-audit

    - name: Run bandit (security linter)
      run: |
        bandit -r ragguard/ -ll -f json -o bandit-report.json || true
        bandit -r ragguard/ -ll

    - name: Check dependencies for known vulnerabilities
      run: |
        pip install -e .
        pip-audit --strict || true
      continue-on-error: true

    - name: Upload bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json
